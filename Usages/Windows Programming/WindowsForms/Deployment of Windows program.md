这节笔记我们简单记录下Windows程序的部署，基本上属于了解内容，实际中只要能够使用实际的项目完成具体任务即可。

# 部署Windows应用程序 #

可以采用多种方式安装Windows应用程序，简单的应用程序可以使用简单的xcopy部署来安装，但对于上百个客户的安装，xcopy部署就没有那么有用了。在这种情况下，可以使用ClickOnce部署，也可以使用Microsoft Windows安装程序来安装应用程序。

在ClickOnce部署中，可以通过单击某个网站的链接来安装应用程序。如果用户选择在其中安装应用程序的目录，或者如果需要一些注册表项，就应使用Windows安装应用程序部署选项。

这里介绍安装Windows应用程序的两个选项。

## 一、部署概述 ##

部署就是把应用程序安装到目标系统上的进程。传统上，这种安装是通过调用安装进程来完成的。如果需要在成百上千个客户机上安装，安装过程就非常耗时。为了缓解这个问题，系统管理员可以创建批处理脚本，自动完成安装过程。但是，这仍需要做大量工作来安装和支持不同客户的PC和不同版本的操作系统。

由于存在这些问题，虽然Windows应用程序可以有更丰富的用户界面，许多公司也把他们内联网应用程序转换为Web应用程序。Web应用程序只需部署到服务器上，客户机就可以自动获取更新后的用户界面。

使用ClickOnce部署，可以解决在部署Windows应用程序时遇到的很多问题。通过单击Web页面中的一个链接即可安装应用程序。客户系统上的用户不需要有管理权限，因为应用程序安装在用户特定的目录下。使用ClickOnce，可以安装带有丰富用户界面的应用程序。应用程序安装在客户机上，所以在安装完成后，不需要保留与客户系统的连接。换言之，应用程序可以脱机使用。这样，应用程序图标位于Start菜单上，安全问题更容易解决，应用程序也很容易卸载。

ClickOnce的一个出色功能是，当客户应用程序启动时，更新过程会自动进行，或者在客户应用程序的运行过程中，更新过程会作为一个后台任务来执行。

但是ClickOnce部署也有一些限制：

如果需要在全局应用程序集缓存上安装共享组件，或者应用程序所需的COM组件需要注册表设置，或者希望用户来确定安装应用程序的目录，就不能使用ClickOnce。在这些情况下，必须使用Windows安装程序。Windows安装程序是安装Windows应用程序的传统方式。

下面先介绍ClickOnce部署，再介绍Windows安装程序包。

## 二、ClickOnce部署 ##

在使用ClickOnce部署时，不需要在客户系统上启动安装程序。客户系统的用户只需单击Web页面上的一个链接，应用程序就会自动安装。安装完成后，客户机就可以脱机——客户机不再需要访问从中安装应用程序的服务器。

ClickOnce安装可以在网站、UNC共享或文件位置上进行。利用ClickOnce，应用程序会安装在客户系统上，可以从Start菜单上启动，使用Add/Remove Programs对话框卸载。

ClickOnce部署由清单文件（manifest files）描述。应用程序清单描述了应用程序及需要的权限。部署清单描述了部署配置信息，如更新策略。

### 2.1 创建ClickOnce部署

准备应用程序

程序集名定义了在生成过程中创建的程序集的名称。在安装应用程序时，需要部署这个程序集。通过Assembly Information对话框修改的属性改变了AssemblyInfo.cs文件中的程序集特性。这些元数据信息由部署工具使用。还可以选择可执行文件，单击菜单中的Properties，以便从Windows资源管理器中读取元数据信息。在Details选项卡中可以看到前面添加的信息。

在网络上成功部署程序集，需要使用清单，清单必须有证书签名。该证书会向安装应用程序的用户显示创建安装程序的机构。这样用户就可以确定是否相信该部署。

签署ClickOnce清单 

安装应用程序的用户可以使用证书来辨识安装软件包的创建者。阅读证书的内容，可以确定是否能信任此安装软件包，从而满足安全要求。

创建好测试证书后，用户并没有获得真正值得信任的信息，而是会接收到一个警告，说明这个证书不能信任，如后面所述。这个证书只供测试之用。在应用程序准备好部署之前，必须从证书颁发机构处获得一个真正的证书。如果应用程序只在内联网中部署，还可以从安装在本地网络的本地证书服务器处获得一个证书。Microsoft提供的证书服务器可以与Windows Server一起安装。如果有了证书，就可以通过从Signing选项卡中单击Select from File，来配置它。

定义安全要求

在把程序集安装到客户机上时，必须定义所要求的信任。

通过ClickOnce设置可以把应用程序配置为需要完全信任，或者运行在沙箱中，只能部分信任。

有了完全信任权限，应用程序就可以对系统进行全面的访问，可以执行运行应用程序的用户所允许执行的任何操作。在安装应用程序时，将警告用户：应用程序需要完全信任权限。部分信任的应用程序不能访问文件系统，只能访问独立的存储器或注册表，这种应用程序在沙箱模式下运行。

配置更多的配置项

使用Publish向导

Publish向导在本地的Internet Information Services Web服务器上创建了一个网站。把应用程序的程序集（可执行文件和库）、应用程序和部署清单、Setup.exe和一个示例Web页面publish.htm复制到Web服务器上。部署清单描述了安装信息。

### 2.2 用ClickOnce安装应用程序

1. 打开Web页面publish.htm。
2. 单击Install按钮，安装应用程序。此时会弹出一个安全警告。
3. 单击More Information链接，查看与应用程序相关的潜在安全问题。阅读对话框信息。
4. 阅读完对话框的信息后，单击Close按钮，如果信任所创建的应用程序，就单击Application Install对话框中的Install按钮。

打开publish.htm时，会为目标应用程序检查是否存在.NET运行库。这个检查由HTML页面中的一个Javascript函数来进行。如果运行库未安装，就在安装客户应用程序之前安装运行库。利用默认的发布设置，将从Microsoft站点上复制运行库。

### 2.3 创建和使用应用程序的更新包

有了前面配置的更新选项，客户应用程序会自动检查Web服务器中是否有新版本。

由部署清单中的一个设置和XML元素<update>来定义更新策略。使用Updates按钮和Publish设置可以改变更新策略。一定要使用项目的这些属性来访问Publish设置。

利用Application Updates对话框可以定义客户机是否要查找更新版本。如果要查找更新版本，就可以定义查找是在应用程序启动之前进行，还是在应用程序运行过程中在后台进行更新。如果在后台进行更新，就可以设置更新的时间间隔：是每次启动应用程序时更新。还是每隔特定的小时数、天数或星期数更新一次。

## 三、Visual Studio安装和部署项目类型 ##

VS窗口位置：：Add New Project >> Other Project Types >> Visual Studio Installer >> Installed Templates >> Setup and Deployment

下面是项目类型以及它们的作用：

* 我们要使用Setup Project模板。此模板用于创建Windows安装软件包，所以可以用来部署Windows应用程序。
* Web Setup Project 模板用于安装Web应用程序，这个项目模板将在后面使用。
* Merge Module Project 模板用于创建Windows Installer合并模块。合并模块是安装程序文件，可以包括在多个Microsoft Installer安装软件包中。对于随多个安装程序一起安装的组件而言，可以创建一个合并模块，以在安装软件包中包括此模块。合并模块的一个示例是.NET运行库本身：它在合并模块中提供，因此可以在应用程序的安装软件包中包括.NET运行库。在示例应用程序中将要使用一个合并模块。
* Setup Wizard是选择其他模板的一种方式。可以创建Windows安装软件包、合并模块或CAB文件。
* Cab Project模板允许创建cabinet文件。Cabinet文件可以用于将多个程序集合并到一个文件中，并进行压缩。因为Cabinet文件可以压缩，所以Web客户机可以从服务器上下载较小的文件。

## 四、Microsoft Windows安装程序结构 ##

在Windows Installer推出之前，程序员必须创建定制的安装程序。生成安装程序要做大量繁琐的工作，而且许多程序并不遵循Windows规则。通常要改写旧版本的系统DLL，因为安装程序不会检查版本。

另外，应用程序文件的复制目录通常是错误的。例如如果使用硬编码的目录字符串C:\Program Files但系统管理员改变了默认驱动器号，或使用了操作系统的国际化版本，安装就会失败。

Windows Installer的第一个版本随Office2000发布，它也可以作为分发软件包发布，这些可分发软件包可以包含在其他应用程序软件包中。Windows Installer版本1.1新增了对注册COM+组件的支持，版本1.2支持Windows ME的文件保护机制。版本2.0新增了对.NET程序集安装和Windows64位版本的支持。而在.NET4.0中，允许使用的Windows Installer最低版本是3.1。

### 4.1 Windows安装程序术语

使用Windows安装程序时，必须理解Windows安装程序技术使用的一些术语： 软件包、功能和组件。

软件包包含一个或多个功能块。软件包是单一的Microsoft安装程序（MSI）数据库。功能是用户眼中的产品功能，由多个特性和组件构成。组件是开发人员从安装的角度来看的：它是最小的安装单元，由一个或多个文件组成。

区分功能和组件的原因是单一的组件可以包含在多个功能中，一个功能不能包含在多个功能中。

### 4.2 Windows安装程序的优点

Windows安装程序的优点如下：

* 可以安装功能。也可以不安装功能。或进行通知（advertisement）。有了通知，软件包的功能会在首次使用时安装。或许您在使用Microsoft Word时已经注意到了Windows安装程序的用法。如果未安装Word的通知功能，只要您使用此功能，就会自动安装Word。
* 如果应用程序受损，可以通过Windows安装程序软件包的修复功能自我修复。
* 如果安装失败，就会自动回滚。安装失败之后，所有内容都保持原样：在系统上没有附加的注册表项和文件等。
* 使用卸载功能，可以删除所有的文件，注册表项等。这样就可以完全卸载应用程序。不会留下临时文件，注册表也可以恢复原样。

阅读MSI数据库文件的表，可以获取以下信息：复制了什么文件，写入了什么注册表项等。

## 五、实践 ##